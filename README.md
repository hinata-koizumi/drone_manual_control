# ドローン手動制御環境

> **English**: [README.en.md](README.en.md)

この環境は、ROS 2 Humbleベースのドローン手動制御システムです。Webブラウザからリアルタイムでドローンを制御し、3D可視化でドローンの状態を監視できます。

## 🎯 環境の目的

**強化学習の効率向上のための機体命令応答性検証環境**

この環境は、強化学習アルゴリズム（SAC、PPO、DQN等）の開発・検証において、ドローン機体が命令通りに正確に動作するかを事前に確認するための検証環境です。機体の応答性、制御精度、物理シミュレーションの妥当性を手動で検証することで、強化学習の学習効率と成功率を大幅に向上させることができます。

### 検証可能な項目
- **命令応答性**: 制御コマンドに対する機体の即座の反応
- **制御精度**: 目標位置・速度への到達精度
- **物理特性**: 重力、推力、慣性の妥当性
- **安定性**: 長時間飛行時の安定性
- **安全性**: 制限値内での動作確認

## 🚀 クイックスタート

### 完全自動デプロイ（推奨）
```bash
# ワンクリックでシステムを起動（ブラウザも自動で開きます）
./scripts/quick_start.sh
```

### 段階的デプロイ
```bash
# 1. すべてのパッケージをビルド
./scripts/build_all.sh

# 2. システムを起動
./scripts/start_system.sh
```

### 完全自動化（オプション付き）
```bash
# 完全自動デプロイ（ビルド + 起動 + ヘルスチェック）
./scripts/auto_deploy.sh

# オプション付きデプロイ
./scripts/auto_deploy.sh --clean        # クリーンな状態から開始
./scripts/auto_deploy.sh --build-only   # ビルドのみ実行
./scripts/auto_deploy.sh --start-only   # 既存ビルドで起動のみ
./scripts/auto_deploy.sh --no-web-viz   # Web可視化を無効にして起動
```

## 🎮 動作確認済み機能

### ドローン制御コマンド
✅ **Take Off**: ドローンが上昇（Z軸正方向）  
✅ **Land**: ドローンが下降（Z軸負方向）  
✅ **Forward**: ドローンが前進（X軸正方向）  
✅ **Backward**: ドローンが後退（X軸負方向）  
✅ **Left**: ドローンが左移動（Y軸正方向）  
✅ **Right**: ドローンが右移動（Y軸負方向）  
✅ **Up**: ドローンが上昇（Z軸正方向、中程度）  
✅ **Down**: ドローンが下降（Z軸負方向、中程度）  
✅ **Stop**: すべての移動を停止  
✅ **Hover**: ホバリング状態の維持  
✅ **Reset**: ドローンを初期位置(0,0,0)にリセット  

### リアルタイム表示
✅ **位置情報**: X, Y, Z座標のリアルタイム更新  
✅ **速度情報**: X, Y, Z軸の速度のリアルタイム更新  
✅ **WebSocket通信**: 安定したリアルタイム通信  
✅ **3D可視化**: ブラウザベースのドローン位置表示  

### 3Dビジュアライゼーション機能
✅ **リアルタイム3D表示**: Three.jsベースの美しい3D可視化  
✅ **カメラ操作**: マウスドラッグで回転、ホイールでズーム、右クリックでパン  
✅ **カメラ追従モード**: ON/OFF切り替え可能なドローン追従機能  
✅ **ブラウザズーム防止**: 3Dビュー内でのみズームが効く直感的な操作  
✅ **美しいドローン3Dモデル**: 白色、光沢効果付きの可視性の高いモデル  
✅ **グリッド表示**: 位置関係を把握しやすいグリッド表示  
✅ **操作説明**: 直感的な操作ガイド表示  

## 専用ドローン機体情報

### Aether-SL

手動制御環境専用に設計された高性能ドローン機体です。

#### **基本仕様**
- **機体タイプ**: ストリームライン型クアッドコプター
- **重量**: 0.65kg
- **サイズ**: 32.5cm × 32.5cm × 7cm
- **最大速度**: 23.6 m/s（85 km/h）
- **最大高度**: 50m
- **飛行時間**: 約25分（シミュレーション）
- **最大航続距離**: 20km

#### **推進システム**
- **メインローター**: 4基（6インチプロペラ、最大11000rpm）
- **制御チャンネル**: 4チャンネル（4ローター）
- **推力定数**: 1.6（高効率設計）

#### **安全機能**
- **ジオフェンス**: 水平20km、垂直50m制限
- **フェイルセーフ**: RC信号喪失時の自動帰還
- **速度制限**: 水平23.6m/s、垂直8m/s
- **加速度制限**: 最大12m/s²

#### **制御パラメータ**
- **姿勢制御**: PID制御（Roll/Pitch: P=4.8, I=0.18, D=0.09）
- **位置制御**: PID制御（XY: P=1.0, I=0.1, D=0.05）
- **手動制御**: 傾斜角制限80%、ヨー角制限80%

#### **フライトモード**
- **STABILIZE**: 姿勢安定化モード
- **ALT_HOLD**: 高度保持モード
- **LOITER**: 位置保持モード
- **AUTO**: 自動飛行モード
- **RTL**: 自動帰還モード
- **MANUAL**: 手動制御モード

詳細仕様は `config/drone_specs.yaml` を参照してください。

## システム構成

### コンテナ構成
- **drone_msgs**: カスタムメッセージ定義
- **bridge**: ROS 2通信ブリッジ
- **manual_control**: ドローンシミュレーターと制御システム
- **web_viz**: Web可視化と制御インターフェース

### 技術スタック
- **ROS 2 Humble**: 基盤となる通信システム
- **Docker Compose**: マルチコンテナ環境
- **WebSocket**: リアルタイムなWeb UI通信
- **Python**: シミュレーションと制御ロジック
- **JavaScript/Three.js**: Web UIフロントエンドと3D可視化

## 特徴

- **リアルタイム制御**: Webブラウザから即座にドローンを制御
- **物理シミュレーション**: 重力、推力、制御を考慮したリアルisticな動作
- **ROS 2 Humble対応**: 最新のROS 2フレームワークを使用
- **Docker統合**: 再現可能な開発環境
- **モジュラー設計**: 既存のブリッジコンポーネントを再利用
- **Web可視化**: ブラウザベースの3D可視化と手動制御
- **完全自動化**: ワンクリックでシステム構築から起動まで
- **マルチプロセス対応**: 安定したWebSocket通信とROS 2統合
- **直感的な3D操作**: マウス操作でカメラを自由に制御
- **カメラ追従機能**: ドローンを自動追従するカメラモード
- **完全なリセット機能**: ドローンを初期位置に確実にリセット
- **強化学習対応**: SAC、PPO、DQN等のアルゴリズム開発・検証に最適化
- **命令応答性検証**: 機体の制御精度と応答性を事前確認
- **学習効率向上**: 手動検証による強化学習の成功率向上

## 移行されたコンポーネント

### 基盤コンポーネント
- `common/` - BridgeBaseクラスとユーティリティ
- `drone_msgs/` - カスタムメッセージ定義
- `px4_msgs/` - PX4メッセージ定義

### ブリッジノード
- `command_bridge/` - 制御コマンド変換
- `state_bridge/` - 状態情報変換

## 新規追加コンポーネント

### 手動制御システム
- `manual_control/` - ドローンシミュレーターと制御システム
  - `simple_simulator.py`: 物理シミュレーション
  - `optimized_simulator.py`: 最適化されたシミュレーション
  - `action_executor.py`: アクション実行
  - `state_monitor.py`: 状態監視

### Web可視化システム
- `web_viz/` - ブラウザベースの3D可視化と制御インターフェース
  - `server.py`: WebSocketサーバーとROS 2統合
  - `index.html`: Web UIフロントエンド

## セットアップ手順

### 1. 環境の初期化
```bash
# 既存環境からコンポーネントをコピー
./scripts/setup_environment.sh
```

### 2. 環境のビルド
```bash
# Dockerコンテナをビルド
docker-compose build
```

### 3. デモの実行
```bash
# 自動デモ実行
./scripts/run_demo.sh
```

### 4. 手動実行（オプション）
```bash
# ブリッジノード起動
docker-compose up -d bridge

# 手動制御ノード起動
docker-compose up -d manual_control
```

## 使用方法

### 基本的な使用方法
1. **環境構築**
```bash
cd drone_manual_control
./scripts/setup_environment.sh
docker-compose build
```

2. **システム起動**
```bash
docker-compose up -d
```

3. **Web UIアクセス**
```bash
# ブラウザで以下にアクセス
http://localhost:8080
```

### Web可視化の使用
1. **システム起動後、ブラウザでアクセス**
```
http://localhost:8080
```

2. **利用可能な機能**
- リアルタイム3Dドローン可視化
- 手動制御ボタン（上昇、下降、前進、後退、左移動、右移動）
- ドローン状態のリアルタイム表示（位置、速度）
- WebSocket接続状態の表示
- カメラ追従モードの切り替え
- 完全なリセット機能

3. **制御ボタン**
- **Take Off**: ドローンを上昇させる
- **Land**: ドローンを下降させる
- **Forward/Backward**: 前進/後退
- **Left/Right**: 左移動/右移動
- **Up/Down**: 上昇/下降（中程度）
- **Stop**: すべての移動を停止
- **Hover**: ホバリング状態を維持
- **Reset**: ドローンを初期位置(0,0,0)にリセット

4. **3Dビジュアライゼーション操作**
- **マウスドラッグ**: カメラ回転
- **マウスホイール**: ズームイン/アウト
- **右クリックドラッグ**: カメラパン
- **カメラ追従ボタン**: ON/OFF切り替え
  - **ON**: ドローンを追従（手動操作で角度調整可能）
  - **OFF**: 固定視点（完全手動操作）

5. **3Dビジュアライゼーションの特徴**
- ブラウザ全体のズームを防止し、3Dビュー内でのみズームが効く
- 美しい白色のドローン3Dモデル（光沢効果付き）
- 位置関係を把握しやすいグリッド表示
- 直感的な操作ガイド表示
- カメラ追従モードでも手動操作で角度調整可能

### 強化学習開発者向け使用方法
1. **機体応答性の事前検証**
   - 手動制御で機体の応答性を確認
   - 制御コマンドと実際の動作の遅延を測定
   - 物理パラメータの妥当性を検証

2. **報酬関数の設計支援**
   - 手動制御による目標達成の難易度評価
   - 各行動の実行時間と精度の測定
   - 報酬の重み付けの参考データ収集

3. **学習環境の調整**
   - 状態空間と行動空間の範囲設定
   - エピソード長と終了条件の最適化
   - 初期状態の分布設計

### ログの確認
```bash
# 手動制御ノードのログ
docker-compose logs -f manual_control

# Web可視化のログ
docker-compose logs -f web_viz

# 全ノードのログ
docker-compose logs -f
```

### 環境の停止
```bash
docker-compose down
```

## 技術的な詳細

### 修正済みの問題
1. **推力計算の修正**: `abs()`関数を削除して、landingコマンドの負のスロットル値を正しく処理
2. **QoS設定の統一**: web_vizとシミュレーター間の通信設定を一致
3. **データ共有の改善**: マルチプロセス間のデータ転送を最適化
4. **水平移動の対応**: `linear.x`と`linear.y`コマンドを正しく処理
5. **リアルタイム更新**: UIの位置と速度データがリアルタイムで更新
6. **リセット機能の改善**: 完全なリセット機能とクールダウン期間の実装
7. **3Dビジュアライゼーションの改善**: ブラウザズーム防止、カメラ追従機能、直感的な操作
8. **カメラ追従モードの安定化**: スコープ問題の解決と手動操作との組み合わせ

### 新機能と改善点
1. **完全なリセット機能**: ドローンを確実に初期位置(0,0,0)にリセット
2. **リセット後のクールダウン**: 1秒間の制御コマンド無視期間
3. **3Dビジュアライゼーション**: Three.jsベースの美しい3D表示
4. **カメラ追従機能**: ON/OFF切り替え可能なドローン追従
5. **直感的な操作**: ブラウザズーム防止、マウス操作の改善
6. **美しいUI**: 白色ドローン3Dモデル、光沢効果、グリッド表示

### 強化学習対応機能
1. **Gym API互換**: OpenAI Gymスタイルのインターフェース
2. **動的アクチュエータマッピング**: SAC等のアルゴリズムに対応
3. **状態空間の標準化**: 位置、速度、姿勢の正規化
4. **行動空間の連続制御**: 連続的な推力制御に対応
5. **報酬関数の検証**: 手動制御による報酬設計の妥当性確認
6. **エピソード管理**: 自動リセットとエピソード終了条件

### 通信フロー
1. **Web UI** → **WebSocket** → **ROS 2 Control Node** → **TwistStamped** → **Simulator**
2. **Simulator** → **PoseStamped/TwistStamped** → **ROS 2 Control Node** → **WebSocket** → **Web UI**

### 物理シミュレーション
- **重力**: 9.81 m/s²
- **推力**: 可変推力（制御コマンドに応じて）
- **質量**: 0.65 kg
- **制御**: PID制御による姿勢制御
- **衝突検出**: 地面との衝突処理

## 自動化スクリプト

### `scripts/auto_deploy.sh` - 完全自動デプロイ
- ビルドから起動、ヘルスチェックまで完全自動化
- オプション付きで柔軟な運用が可能

### `scripts/quick_start.sh` - クイックスタート
- ワンクリックでシステム起動
- ブラウザも自動で開く

### `scripts/build_all.sh` - 段階的ビルド
- 各パッケージを順次ビルド
- 詳細なログ出力

### `scripts/start_system.sh` - システム起動
- 既存ビルドを使用してシステム起動

## トラブルシューティング

### よくある問題
1. **WebSocket接続エラー**: ポート8080が使用中の場合、他のプロセスを停止
2. **ROS 2通信エラー**: コンテナ間のネットワーク設定を確認
3. **UIが更新されない**: ブラウザのキャッシュをクリア
4. **3Dビューが表示されない**: ブラウザのWebGL対応を確認
5. **カメラ追従が動作しない**: ブラウザのコンソールでエラーログを確認
6. **リセットボタンが効かない**: リセット後のクールダウン期間（1秒）を待つ

### デバッグ方法
```bash
# リアルタイムログ確認
docker-compose logs -f

# 特定コンテナのログ確認
docker-compose logs -f manual_control
docker-compose logs -f web_viz

# コンテナ内でのROS 2トピック確認
docker-compose exec manual_control bash -c "source /opt/ros/humble/setup.bash && ros2 topic list"

# ブラウザの開発者ツールでデバッグ
# F12キーを押してコンソールタブでログを確認
# カメラ追従モードの切り替えログやエラーメッセージを確認
```

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

# Manual control CI trigger
