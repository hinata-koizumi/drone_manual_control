name: Simulation Environment Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/manual_control/**'
      - 'config/**'
      - 'tests/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/manual_control/**'
      - 'config/**'
      - 'tests/**'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®æ§‹ç¯‰ãƒ†ã‚¹ãƒˆ
  build-simulation:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up ROS 2 Humble
      run: |
        # ROS 2 Humbleã®æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆGPGã‚­ãƒ¼ã®å•é¡Œã‚’å›é¿ï¼‰
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository universe
        sudo apt-get update && sudo apt-get install -y curl gnupg2 lsb-release
        sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y ros-humble-ros-base python3-colcon-common-extensions
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-colcon-common-extensions \
          python3-pip \
          python3-yaml \
          python3-numpy
    
    - name: Install ROS 2 packages
      run: |
        sudo apt-get install -y \
          ros-humble-geometry-msgs \
          ros-humble-sensor-msgs \
          ros-humble-std-msgs \
          ros-humble-rclpy \
          ros-humble-launch-ros
    
    - name: Create workspace
      run: |
        mkdir -p ~/sim_ws/src
        cd ~/sim_ws/src
        ln -s $GITHUB_WORKSPACE/src/manual_control .
    
    - name: Build simulation package
      run: |
        cd ~/sim_ws
        source /opt/ros/humble/setup.sh
        colcon build --packages-select manual_control --event-handlers console_direct+
    
    - name: Test build artifacts
      run: |
        cd ~/sim_ws
        source /opt/ros/humble/setup.sh
        source install/setup.sh
        
        # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª
        ros2 pkg executables manual_control
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        ls -la install/manual_control/share/manual_control/config/
        
        # launchãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        ls -la install/manual_control/share/manual_control/launch/

  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
  test-simulation-components:
    runs-on: ubuntu-22.04
    needs: build-simulation
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up ROS 2 Humble
      run: |
        # ROS 2 Humbleã®æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆGPGã‚­ãƒ¼ã®å•é¡Œã‚’å›é¿ï¼‰
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository universe
        sudo apt-get update && sudo apt-get install -y curl gnupg2 lsb-release
        sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y ros-humble-ros-base python3-colcon-common-extensions
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-colcon-common-extensions python3-pip
        sudo apt-get install -y ros-humble-geometry-msgs ros-humble-sensor-msgs ros-humble-rclpy
        pip install pytest pyyaml numpy
    
    - name: Build and test components
      run: |
        mkdir -p ~/sim_ws/src
        cd ~/sim_ws/src
        ln -s $GITHUB_WORKSPACE/src/manual_control .
        
        cd ~/sim_ws
        source /opt/ros/humble/setup.sh
        colcon build --packages-select manual_control
        
        # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        source install/setup.sh
        python3 -c "
        import sys
        import os
        
        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‘ã‚¹ã®è¿½åŠ 
        sys.path.insert(0, os.path.join(os.path.expanduser('~'), 'sim_ws', 'src', 'manual_control', 'manual_control'))
        
        try:
            # å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            from simple_simulator import SimpleDroneSimulator
            print('âœ… SimpleDroneSimulator imported successfully')
            
            from state_monitor import StateMonitorNode
            print('âœ… StateMonitorNode imported successfully')
            
            from action_executor import ActionExecutorNode
            print('âœ… ActionExecutorNode imported successfully')
            
            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
            import yaml
            config_path = os.path.join('config', 'drone_specs.yaml')
            with open(config_path, 'r') as f:
                drone_specs = yaml.safe_load(f)
            
            specs = drone_specs['drone_specifications']
            print(f'âœ… Drone specs loaded: {specs["name"]} v{specs["version"]}')
            
        except Exception as e:
            print(f'âŒ Error: {e}')
            sys.exit(1)
        "

  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
  test-simulation-execution:
    runs-on: ubuntu-22.04
    needs: test-simulation-components
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up ROS 2 Humble
      run: |
        # ROS 2 Humbleã®æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆGPGã‚­ãƒ¼ã®å•é¡Œã‚’å›é¿ï¼‰
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository universe
        sudo apt-get update && sudo apt-get install -y curl gnupg2 lsb-release
        sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y ros-humble-ros-base python3-colcon-common-extensions
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-colcon-common-extensions
        sudo apt-get install -y ros-humble-geometry-msgs ros-humble-sensor-msgs ros-humble-rclpy
    
    - name: Build workspace
      run: |
        mkdir -p ~/sim_ws/src
        cd ~/sim_ws/src
        ln -s $GITHUB_WORKSPACE/src/manual_control .
        
        cd ~/sim_ws
        source /opt/ros/humble/setup.sh
        colcon build --packages-select manual_control
    
    - name: Test simulation startup
      run: |
        cd ~/sim_ws
        source /opt/ros/humble/setup.sh
        source install/setup.sh
        
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’èµ·å‹•
        timeout 30s ros2 run manual_control simple_simulator &
        SIM_PID=$!
        
        # å°‘ã—å¾…æ©Ÿ
        sleep 5
        
        # ãƒˆãƒ”ãƒƒã‚¯ã®ç¢ºèª
        ros2 topic list | grep -E "(drone|imu)" || echo "No drone topics found"
        
        # ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèª
        if ps -p $SIM_PID > /dev/null; then
            echo "âœ… Simulation process is running"
            kill $SIM_PID
        else
            echo "âŒ Simulation process failed to start"
            exit 1
        fi

  # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¦¥å½“æ€§ãƒ†ã‚¹ãƒˆ
  test-configuration:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test drone_specs.yaml
      run: |
        python3 -c "
        import yaml
        import sys
        
        # drone_specs.yamlã®è©³ç´°ãƒ†ã‚¹ãƒˆ
        with open('config/drone_specs.yaml', 'r') as f:
            data = yaml.safe_load(f)
        
        specs = data['drone_specifications']
        
        # ç‰©ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ç¢ºèª
        mass = specs['physical']['weight']
        if mass <= 0 or mass > 10:
            print(f'âŒ Invalid mass: {mass}kg')
            sys.exit(1)
        
        # ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ç¢ºèª
        thrust_constant = specs['motors']['main_rotors']['thrust_constant']
        if thrust_constant <= 0:
            print(f'âŒ Invalid thrust_constant: {thrust_constant}')
            sys.exit(1)
        
        # åˆ¶å¾¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ç¢ºèª
        roll_p = specs['control']['attitude']['roll_p']
        if roll_p <= 0:
            print(f'âŒ Invalid roll_p: {roll_p}')
            sys.exit(1)
        
        print('âœ… drone_specs.yaml validation passed')
        "
    
    - name: Test action_sequences.yaml
      run: |
        python3 -c "
        import yaml
        import sys
        
        # action_sequences.yamlã®è©³ç´°ãƒ†ã‚¹ãƒˆ
        with open('config/action_sequences.yaml', 'r') as f:
            data = yaml.safe_load(f)
        
        sequences = data['action_sequences']
        
        # å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¦¥å½“æ€§ç¢ºèª
        for i, action in enumerate(sequences):
            if 'duration' not in action or action['duration'] <= 0:
                print(f'âŒ Invalid duration in action {i}: {action.get("duration", "missing")}')
                sys.exit(1)
            
            if 'action_type' not in action:
                print(f'âŒ Missing action_type in action {i}')
                sys.exit(1)
        
        print(f'âœ… action_sequences.yaml validation passed: {len(sequences)} actions')
        "

  # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  simulation-report:
    runs-on: ubuntu-22.04
    needs: [build-simulation, test-simulation-components, test-simulation-execution, test-configuration]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate simulation test report
      run: |
        echo "## ğŸš Simulation Environment Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Status:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build simulation: ${{ needs.build-simulation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Test components: ${{ needs.test-simulation-components.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Test execution: ${{ needs.test-simulation-execution.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Test configuration: ${{ needs.test-configuration.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Simulation Components:" >> $GITHUB_STEP_SUMMARY
        echo "- SimpleDroneSimulator: Ready" >> $GITHUB_STEP_SUMMARY
        echo "- StateMonitorNode: Ready" >> $GITHUB_STEP_SUMMARY
        echo "- ActionExecutorNode: Ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration Files:" >> $GITHUB_STEP_SUMMARY
        echo "- drone_specs.yaml: Valid" >> $GITHUB_STEP_SUMMARY
        echo "- action_sequences.yaml: Valid" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- Run full simulation with launch file" >> $GITHUB_STEP_SUMMARY
        echo "- Test specific drone actions" >> $GITHUB_STEP_SUMMARY
        echo "- Validate physics simulation" >> $GITHUB_STEP_SUMMARY 